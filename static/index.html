<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²ç¨‹ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        /* èª¿æ•´è¼¸å…¥æ¡†æ¨£å¼ï¼Œè®“å®ƒçœ‹èµ·ä¾†åƒè¡¨æ ¼ */
        .table input.form-control { 
            font-size: 0.95rem; 
            padding: 0.3rem; 
            text-align: center;
            border: 1px solid #ced4da;
            background-color: #fff;
        }
        .table input.form-control:focus {
            background-color: #e8f0fe; /* ç·¨è¼¯æ™‚è®Šè‰² */
        }
    </style>
</head>
<body>

    <div class="container">
        <h2 class="mb-4 text-primary fw-bold">ğŸ“š èª²ç¨‹ç®¡ç†ç³»çµ± (å…¨æ¬„ä½å¯ç·¨è¼¯ç‰ˆ)</h2>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">æ–°å¢èª²ç¨‹</div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-2"><input type="text" id="newCode" class="form-control" placeholder="ä»£ç¢¼ (ä¾‹: AAA)"></div>
                    <div class="col-md-2"><input type="text" id="newSem" class="form-control" placeholder="å­¸æœŸ (ä¾‹: 2025J)"></div>
                    <div class="col-md-2"><input type="number" id="newYear" class="form-control" placeholder="å¹´ä»½ (ä¾‹: 2025)"></div>
                    <div class="col-md-2"><input type="text" id="newMonth" class="form-control" placeholder="æœˆä»½ (ä¾‹: February)"></div>
                    <div class="col-md-2"><input type="number" id="newLength" class="form-control" placeholder="é•·åº¦ (å¤©)"></div>
                    <div class="col-md-2 d-grid"><button onclick="createCourse()" class="btn btn-success">+ æ–°å¢</button></div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>èª²ç¨‹åˆ—è¡¨ <small class="text-muted fs-6">(ä¿®æ”¹æ ¼å­å…§å®¹å¾Œï¼Œè«‹æŒ‰å³å´æ›´æ–°æŒ‰éˆ•)</small></h4>
                <button onclick="loadCourses()" class="btn btn-sm btn-outline-secondary">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
            
            <table class="table table-hover align-middle text-center">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 15%">èª²ç¨‹ä»£ç¢¼</th>
                        <th style="width: 15%">å­¸æœŸä»£ç¢¼</th>
                        <th style="width: 15%">å¹´ä»½</th>
                        <th style="width: 20%">æœˆä»½</th>
                        <th style="width: 15%">é•·åº¦ (å¤©)</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="courseTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", loadCourses);

        // 1. è®€å–æ‰€æœ‰èª²ç¨‹
        async function loadCourses() {
            try {
                const res = await fetch("/courses");
                const courses = await res.json();
                const tbody = document.getElementById("courseTableBody");
                tbody.innerHTML = "";

                courses.forEach(c => {
                    // ä½¿ç”¨ã€ŒèˆŠçš„ã€ä»£ç¢¼èˆ‡å­¸æœŸä½œç‚ºè©²è¡Œçš„å”¯ä¸€ ID æ¨™è­˜
                    // é€™æ¨£å°±ç®—ä½¿ç”¨è€…æ”¹äº†è¼¸å…¥æ¡†çš„å…§å®¹ï¼Œæˆ‘å€‘é‚„æ˜¯çŸ¥é“é€™åŸæœ¬æ˜¯å“ªä¸€ç­†è³‡æ–™
                    const uniqueId = `${c.code_module}-${c.code_presentation}`;
                    
                    const row = `
                        <tr>
                            <td><input type="text" id="code-${uniqueId}" class="form-control" value="${c.code_module}"></td>
                            <td><input type="text" id="sem-${uniqueId}" class="form-control" value="${c.code_presentation}"></td>
                            <td><input type="number" id="year-${uniqueId}" class="form-control" value="${c.presentation_year}"></td>
                            <td><input type="text" id="month-${uniqueId}" class="form-control" value="${c.presentation_month}"></td>
                            <td><input type="number" id="len-${uniqueId}" class="form-control" value="${c.module_presentation_length}"></td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button onclick="updateCourse('${c.code_module}', '${c.code_presentation}')" class="btn btn-sm btn-warning text-white">æ›´æ–°</button>
                                    <button onclick="deleteCourse('${c.code_module}', '${c.code_presentation}')" class="btn btn-sm btn-danger">åˆªé™¤</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (err) {
                console.error(err);
                alert("ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼");
            }
        }

        // 2. æ›´æ–°èª²ç¨‹ (åŒ…å«æ‰€æœ‰æ¬„ä½)
        async function updateCourse(oldCode, oldSem) {
            // é€é ID æŠ“å–ç›®å‰ç•«é¢ä¸Š 5 å€‹æ ¼å­çš„æ–°æ•¸å€¼
            const uniqueId = `${oldCode}-${oldSem}`;
            
            // æ”¶é›†æ‰€æœ‰æ¬„ä½è³‡æ–™
            const payload = {
                code_module: document.getElementById(`code-${uniqueId}`).value,
                code_presentation: document.getElementById(`sem-${uniqueId}`).value,
                presentation_year: parseInt(document.getElementById(`year-${uniqueId}`).value), // è½‰æˆæ•¸å­—
                presentation_month: document.getElementById(`month-${uniqueId}`).value,
                module_presentation_length: parseInt(document.getElementById(`len-${uniqueId}`).value) // è½‰æˆæ•¸å­—
            };

            // é˜²å‘†æª¢æŸ¥
            if(!payload.code_module || !payload.code_presentation) {
                alert("èª²ç¨‹ä»£ç¢¼èˆ‡å­¸æœŸä¸å¾—ç‚ºç©ºï¼");
                return;
            }

            try {
                // ç™¼é€ PUT è«‹æ±‚
                const res = await fetch(`/courses/${oldCode}/${oldSem}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                
                if (res.ok) {
                    alert("âœ… ä¿®æ”¹æˆåŠŸï¼");
                    // ä¿®æ”¹æˆåŠŸå¾Œï¼Œå»ºè­°é‡æ–°è¼‰å…¥æ•´å€‹åˆ—è¡¨
                    // å› ç‚ºå¦‚æœä½¿ç”¨è€…æ”¹äº†ä»£ç¢¼ (Primary Key)ï¼ŒID æœƒè®Šï¼Œä¸é‡æ•´ä¸‹æ¬¡æœƒæ‰¾ä¸åˆ°
                    loadCourses(); 
                } else {
                    alert("âŒ æ›´æ–°å¤±æ•—ï¼š" + (result.detail || "æœªçŸ¥éŒ¯èª¤"));
                }
            } catch (err) {
                console.error(err);
                alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤");
            }
        }

        // 3. æ–°å¢èª²ç¨‹
        async function createCourse() {
            const data = {
                code_module: document.getElementById("newCode").value,
                code_presentation: document.getElementById("newSem").value,
                presentation_year: document.getElementById("newYear").value,
                presentation_month: document.getElementById("newMonth").value,
                module_presentation_length: document.getElementById("newLength").value
            };
            
            if(!data.code_module || !data.code_presentation) { 
                alert("ä»£ç¢¼èˆ‡å­¸æœŸå¿…å¡«ï¼"); return; 
            }

            try {
                const res = await fetch("/courses", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert("âœ… æ–°å¢æˆåŠŸ");
                    loadCourses();
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    document.querySelectorAll('.card-body input').forEach(input => input.value = '');
                } else {
                    const err = await res.json();
                    alert("æ–°å¢å¤±æ•—ï¼š" + err.detail);
                }
            } catch (e) { alert("éŒ¯èª¤"); }
        }

        // 4. åˆªé™¤èª²ç¨‹
        async function deleteCourse(code, sem) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤èª²ç¨‹ ${code} (${sem}) å—ï¼Ÿ`)) return;
            try {
                const res = await fetch(`/courses/${code}/${sem}`, { method: "DELETE" });
                if(res.ok) {
                    alert("ğŸ—‘ï¸ å·²åˆªé™¤");
                    loadCourses();
                } else {
                    alert("åˆªé™¤å¤±æ•— (å¯èƒ½æœ‰é—œè¯è³‡æ–™ç„¡æ³•åˆªé™¤)");
                }
            } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
        }
    </script>
</body>
</html>
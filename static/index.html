<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šç”¨è³‡æ–™åº«ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f4f6f9; }
        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow-x: auto;}
        .table input.form-control { 
            font-size: 0.9rem; padding: 0.25rem; min-width: 100px;
        }
        /* è®“è¡¨é ­è®Šæˆå¯é»æ“Šçš„æ¨£å­ */
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #495057; color: #fff; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">ğŸ—„ï¸ é€šç”¨è³‡æ–™åº«ç®¡ç†å¾Œå°</h2>
        <div class="d-flex align-items-center gap-2">
            <label class="fw-bold">é¸æ“‡è¡¨æ ¼ï¼š</label>
            <select id="tableSelector" class="form-select w-auto" onchange="switchTable()">
                <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-success text-white">æ–°å¢è³‡æ–™</div>
        <div class="card-body">
            <div class="row g-2" id="createFormContainer">
                <p class="text-muted">è«‹å…ˆé¸æ“‡è¡¨æ ¼...</p>
            </div>
            <div class="mt-3 text-end">
                <button onclick="createData()" class="btn btn-success" id="btnAdd" disabled>+ ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 id="tableTitle">è³‡æ–™åˆ—è¡¨</h4>
            <span class="text-muted small">ğŸ’¡ é»æ“Šæ¨™é¡Œå¯æ’åºï¼Œä¿®æ”¹è¼¸å…¥æ¡†å¾Œé»æ“Šã€Œæ›´æ–°ã€</span>
        </div>
        
        <table class="table table-bordered table-hover align-middle text-center">
            <thead class="table-dark" id="tableHead">
                </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    let currentTable = "";
    let currentColumns = []; // å„²å­˜ç›®å‰çš„æ¬„ä½åç¨± ['id', 'name', ...]
    let currentSort = { col: "", order: "ASC" };

    document.addEventListener("DOMContentLoaded", init);

    // 1. åˆå§‹åŒ–ï¼šæŠ“å–æ‰€æœ‰è¡¨æ ¼åç¨±
    async function init() {
        try {
            const res = await fetch("/api/tables");
            const tables = await res.json();
            const selector = document.getElementById("tableSelector");
            selector.innerHTML = "";
            
            tables.forEach(t => {
                const opt = document.createElement("option");
                opt.value = t;
                opt.innerText = t;
                selector.appendChild(opt);
            });

            // é è¨­é¸å–ç¬¬ä¸€å€‹è¡¨æ ¼ä¸¦è¼‰å…¥
            if (tables.length > 0) {
                selector.value = tables[0];
                switchTable();
            }
        } catch (e) {
            alert("ç„¡æ³•è®€å–è³‡æ–™åº«è¡¨æ ¼åˆ—è¡¨ï¼");
        }
    }

    // 2. åˆ‡æ›è¡¨æ ¼ï¼šè¼‰å…¥æ¬„ä½çµæ§‹ + è¼‰å…¥è³‡æ–™
    async function switchTable() {
        currentTable = document.getElementById("tableSelector").value;
        document.getElementById("tableTitle").innerText = `è³‡æ–™è¡¨ï¼š${currentTable}`;
        document.getElementById("btnAdd").disabled = false;
        
        // é‡ç½®æ’åº
        currentSort = { col: "", order: "ASC" };

        // å–å¾—è©²è¡¨æ ¼çš„æ¬„ä½çµæ§‹
        const colRes = await fetch(`/api/columns/${currentTable}`);
        const colsData = await colRes.json();
        currentColumns = colsData.map(c => c.column_name);

        // é‡ç¹ªã€Œæ–°å¢è³‡æ–™ã€çš„è¡¨å–®
        renderCreateForm();

        // è¼‰å…¥è³‡æ–™
        loadData();
    }

    // 3. è¼‰å…¥ä¸¦æ¸²æŸ“è³‡æ–™ (å«æ’åº)
    async function loadData() {
        let url = `/api/data/${currentTable}`;
        if (currentSort.col) {
            url += `?sort_by=${currentSort.col}&order=${currentSort.order}`;
        }

        const res = await fetch(url);
        const rows = await res.json();

        // --- ç¹ªè£½è¡¨é ­ (Thead) ---
        const thead = document.getElementById("tableHead");
        thead.innerHTML = "";
        let headRow = "<tr>";
        currentColumns.forEach(col => {
            let sortIcon = "";
            if (currentSort.col === col) {
                sortIcon = currentSort.order === "ASC" ? " â–²" : " â–¼";
            }
            headRow += `<th class="sortable" onclick="setSort('${col}')">${col}${sortIcon}</th>`;
        });
        headRow += "<th>æ“ä½œ</th></tr>";
        thead.innerHTML = headRow;

        // --- ç¹ªè£½å…§å®¹ (Tbody) ---
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        rows.forEach((row, index) => {
            // æˆ‘å€‘æŠŠã€ŒåŸå§‹è³‡æ–™ã€å­˜æˆ JSON å­—ä¸²æ”¾åœ¨ data-original å±¬æ€§è£¡
            // é€™æ¨£æ›´æ–°çš„æ™‚å€™ï¼Œæ‰èƒ½çŸ¥é“èˆŠçš„å€¼æ˜¯ä»€éº¼ï¼Œä»¥ä¾¿ WHERE å®šä½
            const originalJson = JSON.stringify(row).replace(/"/g, '&quot;');
            
            let tr = `<tr data-original="${originalJson}">`;
            
            currentColumns.forEach(col => {
                const val = row[col] !== null ? row[col] : "";
                // æ¯å€‹è¼¸å…¥æ¡†çµ¦ä¸€å€‹ class ç”¨æ–¼æŠ“å–
                tr += `<td><input type="text" class="form-control row-input" data-col="${col}" value="${val}"></td>`;
            });

            tr += `
                <td>
                    <button onclick="updateRow(this)" class="btn btn-sm btn-warning text-white">æ›´æ–°</button>
                    <button onclick="deleteRow(this)" class="btn btn-sm btn-danger">åˆªé™¤</button>
                </td>
            `;
            tr += "</tr>";
            tbody.innerHTML += tr;
        });
    }

    // 4. è¨­å®šæ’åº
    function setSort(col) {
        if (currentSort.col === col) {
            // åˆ‡æ› ASC / DESC
            currentSort.order = currentSort.order === "ASC" ? "DESC" : "ASC";
        } else {
            currentSort.col = col;
            currentSort.order = "ASC";
        }
        loadData();
    }

    // 5. å‹•æ…‹ç”¢ç”Ÿã€Œæ–°å¢è³‡æ–™ã€çš„è¼¸å…¥æ¡†
    function renderCreateForm() {
        const container = document.getElementById("createFormContainer");
        container.innerHTML = "";
        
        currentColumns.forEach(col => {
            const div = document.createElement("div");
            div.className = "col-md-2";
            div.innerHTML = `
                <label class="form-label small text-muted mb-0">${col}</label>
                <input type="text" id="new-${col}" class="form-control" placeholder="${col}">
            `;
            container.appendChild(div);
        });
    }

    // 6. æ–°å¢è³‡æ–™ API
    async function createData() {
        const payload = {};
        currentColumns.forEach(col => {
            const val = document.getElementById(`new-${col}`).value;
            if (val) payload[col] = val; // åªå‚³é€æœ‰å¡«çš„å€¼
        });

        try {
            const res = await fetch(`/api/data/${currentTable}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: payload })
            });
            const result = await res.json();
            
            if (res.ok) {
                alert("âœ… æ–°å¢æˆåŠŸ");
                loadData();
                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.querySelectorAll("#createFormContainer input").forEach(i => i.value = "");
            } else {
                alert("âŒ æ–°å¢å¤±æ•—ï¼š" + result.detail);
            }
        } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
    }

    // 7. æ›´æ–°è³‡æ–™ API
    async function updateRow(btn) {
        const tr = btn.closest("tr");
        
        // å–å¾—èˆŠè³‡æ–™ (ç‚ºäº† WHERE æ¢ä»¶)
        const originalData = JSON.parse(tr.getAttribute("data-original"));
        
        // å–å¾—æ–°è³‡æ–™ (å¾è¼¸å…¥æ¡†è®€å–)
        const newData = {};
        const inputs = tr.querySelectorAll(".row-input");
        inputs.forEach(input => {
            const col = input.getAttribute("data-col");
            newData[col] = input.value;
        });

        const payload = {
            data: newData,
            conditions: originalData
        };

        try {
            const res = await fetch(`/api/data/${currentTable}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            
            if (res.ok) {
                alert("âœ… æ›´æ–°æˆåŠŸ");
                loadData(); // é‡æ–°æ•´ç†ä»¥ç¢ºä¿è³‡æ–™ä¸€è‡´
            } else {
                alert("âŒ æ›´æ–°å¤±æ•—ï¼š" + result.detail);
            }
        } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
    }

    // 8. åˆªé™¤è³‡æ–™ API
    async function deleteRow(btn) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ")) return;
        
        const tr = btn.closest("tr");
        const originalData = JSON.parse(tr.getAttribute("data-original"));

        try {
            // é€™è£¡ç”¨ POST æ­é… /delete è·¯å¾‘ï¼Œå› ç‚º DELETE method å¸¶ body æœ‰äº›ç€è¦½å™¨æ”¯æ´åº¦ä¸ä¸€
            const res = await fetch(`/api/data/${currentTable}/delete`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: originalData })
            });
            
            if (res.ok) {
                alert("ğŸ—‘ï¸ åˆªé™¤æˆåŠŸ");
                loadData();
            } else {
                const result = await res.json();
                alert("åˆªé™¤å¤±æ•—ï¼š" + result.detail);
            }
        } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
    }
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç¸¾è¨ˆç®—èˆ‡ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f4f6f9; }
        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow-x: auto;}
        .table input.form-control { 
            font-size: 0.9rem; padding: 0.25rem; min-width: 100px;
        }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #495057; color: #fff; }
        .pagination-info { font-weight: bold; margin: 0 15px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">ğŸ“ æˆç¸¾è¨ˆç®—èˆ‡ç®¡ç†ç³»çµ±</h2>
        <div class="d-flex align-items-center gap-2">
            <label class="fw-bold">é¸æ“‡è¡¨æ ¼ï¼š</label>
            <select id="tableSelector" class="form-select w-auto" onchange="switchTable()">
                <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-success text-white">æ–°å¢è³‡æ–™</div>
        <div class="card-body">
            <div class="row g-2" id="createFormContainer">
                <p class="text-muted">è«‹å…ˆé¸æ“‡è¡¨æ ¼...</p>
            </div>
            <div class="mt-3 text-end">
                <button onclick="createData()" class="btn btn-success" id="btnAdd" disabled>+ ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 id="tableTitle">è³‡æ–™åˆ—è¡¨</h4>
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary btn-sm" onclick="changePage(-1)" id="btnPrev">â—€ ä¸Šä¸€é </button>
                <span class="pagination-info" id="pageInfo">ç¬¬ 1 é  / å…± 1 é </span>
                <button class="btn btn-outline-secondary btn-sm" onclick="changePage(1)" id="btnNext">ä¸‹ä¸€é  â–¶</button>
                
                <select class="form-select form-select-sm ms-3" style="width: auto;" id="limitSelector" onchange="changeLimit()">
                    <option value="20">æ¯é  20 ç­†</option>
                    <option value="50">æ¯é  50 ç­†</option>
                    <option value="100" selected>æ¯é  100 ç­†</option>
                </select>
            </div>
        </div>
        
        <table class="table table-bordered table-hover align-middle text-center">
            <thead class="table-dark" id="tableHead">
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
        <div id="loadingText" class="text-center text-muted my-3" style="display:none;">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<script>
    let currentTable = "";
    let currentColumns = [];
    let currentSort = { col: "", order: "ASC" };
    
    // ğŸš€ ä¿®æ”¹ï¼šé è¨­ limit æ”¹æˆ 100
    let currentPage = 1;
    let limit = 100; 
    let totalPages = 1;

    document.addEventListener("DOMContentLoaded", init);

    async function init() {
        try {
            const res = await fetch("/api/tables");
            const tables = await res.json();
            const selector = document.getElementById("tableSelector");
            selector.innerHTML = "";
            
            tables.forEach(t => {
                const opt = document.createElement("option");
                opt.value = t;
                opt.innerText = t;
                selector.appendChild(opt);
            });

            if (tables.length > 0) {
                selector.value = tables[0];
                switchTable();
            }
        } catch (e) {
            alert("ç„¡æ³•è®€å–è³‡æ–™åº«è¡¨æ ¼åˆ—è¡¨ï¼");
        }
    }

    async function switchTable() {
        currentTable = document.getElementById("tableSelector").value;
        document.getElementById("tableTitle").innerText = `è³‡æ–™è¡¨ï¼š${currentTable}`;
        document.getElementById("btnAdd").disabled = false;
        
        currentSort = { col: "", order: "ASC" };
        currentPage = 1;

        const colRes = await fetch(`/api/columns/${currentTable}`);
        const colsData = await colRes.json();
        currentColumns = colsData.map(c => c.column_name);

        renderCreateForm();
        loadData();
    }

    async function loadData() {
        document.getElementById("loadingText").style.display = "block";
        document.getElementById("tableBody").innerHTML = "";

        let url = `/api/data/${currentTable}?page=${currentPage}&limit=${limit}`;
        if (currentSort.col) {
            url += `&sort_by=${currentSort.col}&order=${currentSort.order}`;
        }

        try {
            const res = await fetch(url);
            const result = await res.json();
            
            const rows = result.data;
            const pagination = result.pagination;

            totalPages = pagination.total_pages;
            updatePaginationUI(pagination);

            renderTable(rows);

        } catch(e) {
            console.error(e);
            alert("è³‡æ–™è¼‰å…¥å¤±æ•—");
        } finally {
            document.getElementById("loadingText").style.display = "none";
        }
    }

    function renderTable(rows) {
        const thead = document.getElementById("tableHead");
        thead.innerHTML = "";
        let headRow = "<tr>";
        currentColumns.forEach(col => {
            let sortIcon = "";
            if (currentSort.col === col) {
                sortIcon = currentSort.order === "ASC" ? " â–²" : " â–¼";
            }
            headRow += `<th class="sortable" onclick="setSort('${col}')">${col}${sortIcon}</th>`;
        });
        headRow += "<th>æ“ä½œ</th></tr>";
        thead.innerHTML = headRow;

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        if (rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${currentColumns.length + 1}" class="text-muted">æ²’æœ‰è³‡æ–™</td></tr>`;
            return;
        }

        rows.forEach((row) => {
            const originalJson = JSON.stringify(row).replace(/"/g, '&quot;');
            let tr = `<tr data-original="${originalJson}">`;
            
            currentColumns.forEach(col => {
                const val = row[col] !== null ? row[col] : "";
                tr += `<td><input type="text" class="form-control row-input" data-col="${col}" value="${val}"></td>`;
            });

            tr += `
                <td>
                    <button onclick="updateRow(this)" class="btn btn-sm btn-warning text-white">æ›´æ–°</button>
                    <button onclick="deleteRow(this)" class="btn btn-sm btn-danger">åˆªé™¤</button>
                </td>
            `;
            tr += "</tr>";
            tbody.innerHTML += tr;
        });
    }

    function updatePaginationUI(pagination) {
        // é¡¯ç¤ºç›®å‰çš„ç¸½æ•¸ (æœ€å¤š 1000)
        document.getElementById("pageInfo").innerText = `ç¬¬ ${pagination.current_page} é  / å…± ${pagination.total_pages} é  (ç¸½è¨ˆ ${pagination.total_count} ç­†)`;
        
        document.getElementById("btnPrev").disabled = (pagination.current_page <= 1);
        document.getElementById("btnNext").disabled = (pagination.current_page >= pagination.total_pages);
    }

    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage > 0 && newPage <= totalPages) {
            currentPage = newPage;
            loadData();
        }
    }

    function changeLimit() {
        limit = parseInt(document.getElementById("limitSelector").value);
        currentPage = 1;
        loadData();
    }

    function setSort(col) {
        if (currentSort.col === col) {
            currentSort.order = currentSort.order === "ASC" ? "DESC" : "ASC";
        } else {
            currentSort.col = col;
            currentSort.order = "ASC";
        }
        loadData();
    }

    function renderCreateForm() {
        const container = document.getElementById("createFormContainer");
        container.innerHTML = "";
        currentColumns.forEach(col => {
            const div = document.createElement("div");
            div.className = "col-md-2";
            div.innerHTML = `
                <label class="form-label small text-muted mb-0">${col}</label>
                <input type="text" id="new-${col}" class="form-control" placeholder="${col}">
            `;
            container.appendChild(div);
        });
    }

    async function createData() {
        const payload = {};
        currentColumns.forEach(col => {
            const val = document.getElementById(`new-${col}`).value;
            if (val) payload[col] = val;
        });

        try {
            const res = await fetch(`/api/data/${currentTable}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: payload })
            });
            const result = await res.json();
            
            if (res.ok) {
                alert("âœ… æ–°å¢æˆåŠŸ");
                loadData();
                document.querySelectorAll("#createFormContainer input").forEach(i => i.value = "");
            } else {
                alert("âŒ æ–°å¢å¤±æ•—ï¼š" + result.detail);
            }
        } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
    }

    async function updateRow(btn) {
        const tr = btn.closest("tr");
        const originalData = JSON.parse(tr.getAttribute("data-original"));
        const newData = {};
        const inputs = tr.querySelectorAll(".row-input");
        inputs.forEach(input => {
            const col = input.getAttribute("data-col");
            newData[col] = input.value;
        });

        const payload = {
            data: newData,
            conditions: originalData
        };

        try {
            const res = await fetch(`/api/data/${currentTable}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if (res.ok) {
                alert("âœ… æ›´æ–°æˆåŠŸ");
                loadData();
            } else {
                alert("âŒ æ›´æ–°å¤±æ•—ï¼š" + result.detail);
            }
        } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
    }

    async function deleteRow(btn) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ")) return;
        const tr = btn.closest("tr");
        const originalData = JSON.parse(tr.getAttribute("data-original"));

        try {
            const res = await fetch(`/api/data/${currentTable}/delete`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: originalData })
            });
            if (res.ok) {
                alert("ğŸ—‘ï¸ åˆªé™¤æˆåŠŸ");
                loadData();
            } else {
                const result = await res.json();
                alert("åˆªé™¤å¤±æ•—ï¼š" + result.detail);
            }
        } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
    }
</script>

</body>
</html>